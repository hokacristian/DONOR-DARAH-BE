// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum Definitions
enum UserRole {
  admin
  petugas
}

enum EventStatus {
  draft
  active
  completed
}

enum Gender {
  male
  female
}

enum CriteriaType {
  benefit
  cost
}

// Table 1: Users
model User {
  id                    String              @id @default(uuid())
  email                 String              @unique
  password              String
  fullName              String              @map("full_name")
  role                  UserRole
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  createdEvents         Event[]             @relation("CreatedEvents")
  eventOfficers         EventOfficer[]
  registeredDonors      Donor[]             @relation("RegisteredDonors")
  examinedDonors        DonorExamination[]  @relation("ExaminedDonors")
  calculationHistory    CalculationHistory[]
  systemSettingsUpdates SystemSetting[]
  assignedOfficers      EventOfficer[]      @relation("AssignedBy")

  @@map("users")
}

// Table 2: Criteria
model Criteria {
  id                        Int                           @id @default(autoincrement())
  code                      String                        @unique
  name                      String
  type                      CriteriaType
  weight                    Float                         @default(0)
  createdAt                 DateTime                      @default(now()) @map("created_at")
  updatedAt                 DateTime                      @updatedAt @map("updated_at")

  // Relations
  subCriteria               SubCriteria[]
  examinationCriteriaValues ExaminationCriteriaValue[]

  @@map("criteria")
}

// Table 3: Sub Criteria
model SubCriteria {
  id          Int       @id @default(autoincrement())
  criteriaId  Int       @map("criteria_id")
  name        String
  value       Int
  minValue    Float?    @map("min_value")
  maxValue    Float?    @map("max_value")
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  criteria    Criteria  @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@map("sub_criteria")
}

// Table 4: Events
model Event {
  id                  String               @id @default(uuid())
  name                String
  location            String
  startDate           DateTime             @map("start_date")
  endDate             DateTime             @map("end_date")
  status              EventStatus          @default(draft)
  description         String?
  createdBy           String               @map("created_by")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")

  // Relations
  creator             User                 @relation("CreatedEvents", fields: [createdBy], references: [id])
  eventOfficers       EventOfficer[]
  donors              Donor[]
  calculationHistory  CalculationHistory[]

  @@map("events")
}

// Table 5: Event Officers
model EventOfficer {
  id          Int       @id @default(autoincrement())
  eventId     String    @map("event_id")
  userId      String    @map("user_id")
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  assignedBy  String    @map("assigned_by")

  // Relations
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assigner    User      @relation("AssignedBy", fields: [assignedBy], references: [id])

  @@unique([eventId, userId])
  @@map("event_officers")
}

// Table 6: Donors
model Donor {
  id              String              @id @default(uuid())
  eventId         String              @map("event_id")
  fullName        String              @map("full_name")
  birthDate       DateTime            @map("birth_date")
  gender          Gender
  bloodType       String              @map("blood_type")
  phone           String
  address         String
  registeredBy    String              @map("registered_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  event           Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrar       User                @relation("RegisteredDonors", fields: [registeredBy], references: [id])
  examinations    DonorExamination[]

  @@map("donors")
}

// Table 7: Donor Examinations
model DonorExamination {
  id                      String                      @id @default(uuid())
  donorId                 String                      @map("donor_id")
  bloodPressureSystolic   Int                         @map("blood_pressure_systolic")
  bloodPressureDiastolic  Int                         @map("blood_pressure_diastolic")
  weight                  Float
  hemoglobin              Float
  medicationFreeDays      Int                         @map("medication_free_days")
  age                     Int
  lastSleepHours          Float                       @map("last_sleep_hours")
  hasDiseaseHistory       Boolean                     @map("has_disease_history")
  examinationDate         DateTime                    @default(now()) @map("examination_date")
  examinedBy              String                      @map("examined_by")
  createdAt               DateTime                    @default(now()) @map("created_at")
  updatedAt               DateTime                    @updatedAt @map("updated_at")

  // Relations
  donor                   Donor                       @relation(fields: [donorId], references: [id], onDelete: Cascade)
  examiner                User                        @relation("ExaminedDonors", fields: [examinedBy], references: [id])
  criteriaValues          ExaminationCriteriaValue[]
  mooraCalculations       MooraCalculation[]

  @@map("donor_examinations")
}

// Table 8: Examination Criteria Values
model ExaminationCriteriaValue {
  id              Int               @id @default(autoincrement())
  examinationId   String            @map("examination_id")
  criteriaId      Int               @map("criteria_id")
  rawValue        Float             @map("raw_value")
  normalizedValue Int               @map("normalized_value")
  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  examination     DonorExamination  @relation(fields: [examinationId], references: [id], onDelete: Cascade)
  criteria        Criteria          @relation(fields: [criteriaId], references: [id])

  @@unique([examinationId, criteriaId])
  @@map("examination_criteria_values")
}

// Table 9: MOORA Calculations
model MooraCalculation {
  id                String            @id @default(uuid())
  examinationId     String            @map("examination_id")
  normalizedMatrix  Json              @map("normalized_matrix")
  optimizationValue Float             @map("optimization_value")
  rank              Int
  isEligible        Boolean           @map("is_eligible")
  calculatedAt      DateTime          @default(now()) @map("calculated_at")
  createdAt         DateTime          @default(now()) @map("created_at")

  // Relations
  examination       DonorExamination  @relation(fields: [examinationId], references: [id], onDelete: Cascade)

  @@unique([examinationId])
  @@map("moora_calculations")
}

// Table 10: System Settings
model SystemSetting {
  id          Int       @id @default(autoincrement())
  key         String    @unique
  value       String
  description String?
  updatedBy   String    @map("updated_by")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  updater     User      @relation(fields: [updatedBy], references: [id])

  @@map("system_settings")
}

// Table 11: Calculation History (for audit)
model CalculationHistory {
  id                  String    @id @default(uuid())
  eventId             String    @map("event_id")
  totalDonors         Int       @map("total_donors")
  eligibleCount       Int       @map("eligible_count")
  calculationDetails  Json      @map("calculation_details")
  generatedBy         String    @map("generated_by")
  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  event               Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  generator           User      @relation(fields: [generatedBy], references: [id])

  @@map("calculation_history")
}
